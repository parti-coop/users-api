language: ruby

rvm:
  - 2.3.0

env:
  global:
    - USERS_API_REPO=partixyz/users-api
    - secure: opowKE+EGKT26DpJQvFs6k8Y30jTaYuA7WvUPzGhiMND/L6w7r+zzoqjjpZ7SJY9qqdppoDC95O6vP3PMOYzFJh7w3YOFyprXTdWsVjEozQjStgEZlOwT+vc+98XUy5G4BV9GiCOv7e6S11wGkStITDp1XC8kLkHDNqOCMT3OatsNOUZrk7WH3VhGSQxbkxkpvf9vntH/fwTESYCMKwYrRQo58fitL3d0RpEr+C8/jiIdzSD+CTDK4Te5v460uCcwxT3QFd3dUo58G8HuLg45YVSWmXuUr6pqdHyv5jwL+JkJlkM+q4ae965Cjh7pMsv/y9fTyMwnsFGl6sW8KIauA==
    - secure: 4JS/qIgCDT2wSNjekqDZB1SF7MaBocFxSAu50An8qhxCcixSBwTzx2/Xvs3wcjqroS877G02k+Jiiu38KZSH3gP5xX8LOl38aMLS3jfm1Dmab6F6e9FOH9G85nP3Y1S9+wHEu6FqExuvdkJmT0k/K/+qL5EDWpHyrkkt0s4bjbIpdoNAV45HncwNydvaFoopk9BugSHDeiUwhx5+3IBNHJtCZVwvfxr2Ck0j0gliShI/m0gX1twvVAP7QGoB1hiBglGeoM8PSKogOGJm3/XZ2MgqjRVLrn98WLY3y1DVVidN/U3wDUoQgov1cgb36vDhKl/6Vzwcx3CehzoRnqdFCQ==

before_install:
  - sudo apt-get -y update
  - sudo apt-get -y install libpq-dev
  - apt-get -y install python-dev
  - sudo pip install -U docker-compose
  - export APP_VERSION=$( git describe  --tags --long || echo ${COMMIT::12} )

before_script:
  - docker-compose -f deploy/docker-compose-test.yml up -d db
  - DB_CONTAINER=$( docker-compose -f deploy/docker-compose-test.yml ps -q db )
  - export DB_HOST=$( docker inspect --format '{{ .NetworkSettings.IPAddress }}' $DB_CONTAINER )
  - docker-compose -f deploy/docker-compose-test.yml run --rm auth-api bin/rails db:setup
  - RAILS_ENV=test bin/rails db:setup
  - docker-compose -f deploy/docker-compose-test.yml up -d auth-api
  - AUTH_API_CONTAINER=$( docker-compose -f deploy/docker-compose-test.yml ps -q auth-api )
  - export AUTH_API_HOST=$( docker inspect --format '{{ .NetworkSettings.IPAddress }}' $AUTH_API_CONTAINER )

script:
  - RALIS_ENV=test bin/rails spec

after_success:
  - docker build -t partixyz/users-api:$APP_VERSION .
  - docker push partixyz/users-api:$APP_VERSION

integrations:
  hub:
    - integrationName: partixyz
      type: docker 
